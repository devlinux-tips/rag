# Croatian RAG System - Main Configuration
# Consolidated configuration file for all system components

# ============================================================================
# SHARED CONFIGURATION
# ============================================================================
[shared]
# Common directories (unified for all components)
cache_dir = "./data/cache"
metrics_dir = "./data/metrics"
models_dir = "./models"
logs_dir = "./logs"

# Common timeouts (shared across components)
default_timeout = 120.0
request_timeout = 120.0
processing_timeout = 300.0
embedding_timeout = 180.0
retrieval_timeout = 60.0
generation_timeout = 120.0

# Common model settings
default_device = "cpu" # "cpu" "cuda"
default_batch_size = 32

# Context and chunk size standards
default_max_context_length = 2500
default_chunk_size = 512
default_chunk_overlap = 50
min_chunk_size = 100

# Search defaults
default_top_k = 5
similarity_threshold = 0.3

# ============================================================================
# LANGUAGE CONFIGURATION
# ============================================================================
[languages]
# Supported languages - add new languages here
# Convention: Language code maps directly to config file (hr -> hr.toml, en -> en.toml)
supported = ["hr", "en"]
default = "hr"
auto_detect = false  # For future implementation

# Language display names
[languages.names]
hr = "Croatian"
en = "English"

# ============================================================================
# PROJECT SETTINGS
# ============================================================================
[project]
name = "Croatian RAG System"
version = "1.0.0"
description = "Advanced RAG system optimized for Croatian language"
author = "RAG Team"

[paths]
# Multi-tenant base directories
data_base_dir = "./data"
models_base_dir = "./models"
system_dir = "./system"

# Multi-tenant path templates - explicit configuration for flexibility
# Templates use {variable} format and are rendered with tenant/user/language data
tenant_root_template = "{data_base_dir}/{tenant_slug}"
user_documents_template = "{data_base_dir}/{tenant_slug}/users/{user_id}/documents/{language}"
tenant_shared_template = "{data_base_dir}/{tenant_slug}/shared/documents/{language}"
user_processed_template = "{data_base_dir}/{tenant_slug}/users/{user_id}/processed/{language}"
tenant_processed_template = "{data_base_dir}/{tenant_slug}/shared/processed/{language}"
chromadb_path_template = "{data_base_dir}/{tenant_slug}/vectordb"
models_path_template = "{models_base_dir}/{tenant_slug}/{language}"

# Legacy single-tenant directories (deprecated - use templates above)
documents_dir = "./data/raw"           # Use user_documents_template instead
processed_dir = "./data/processed"     # Use user_processed_template instead
test_data_dir = "./data/test"          # Use tenant structure instead
cache_dir = "./data/cache"             # Now per-tenant: {tenant_root}/cache
temp_dir = "./temp"                    # System-wide temp
export_dir = "./data/exports"          # Now per-tenant: {tenant_root}/exports

# Language-specific subdirectories (handled by templates)
use_language_subdirs = true

[logging]
level = "INFO"
format = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
log_to_file = true

# ============================================================================
# EMBEDDING CONFIGURATION
# ============================================================================
[embeddings]
# Primary embedding model settings
model_name = "BAAI/bge-m3"  # Primary multilingual model
device = "cpu"  # Uses shared.default_device
max_seq_length = 512
batch_size = 32  # Uses shared.default_batch_size
normalize_embeddings = true

# Security and loading preferences
use_safetensors = true  # Use safetensors format for security (PyTorch 2.6+ vulnerability fix)
trust_remote_code = false  # Security setting for model loading
torch_dtype = "auto"  # or "float32", "float16", "bfloat16"

# Recommended models for multilingual support
[embeddings.recommended_models]
bge_m3 = "BAAI/bge-m3"  # Primary multilingual model
labse = "sentence-transformers/LaBSE"  # Secondary: Language-Agnostic BERT
multilingual_minilm = "paraphrase-multilingual-MiniLM-L12-v2"  # Fast option
multilingual_mpnet = "paraphrase-multilingual-mpnet-base-v2"  # Accuracy option
distiluse_multilingual = "distiluse-base-multilingual-cased"  # Lightweight option

# Language-specific models (for reference by language configs)
all_minilm_l6 = "sentence-transformers/all-MiniLM-L6-v2"  # English-optimized fast model
all_mpnet_base = "sentence-transformers/all-mpnet-base-v2"  # English-optimized accuracy model
bge_small_en = "BAAI/bge-small-en-v1.5"  # English-specific BGE small
bge_base_en = "BAAI/bge-base-en-v1.5"  # English-specific BGE base

# Similarity calculation settings
[embeddings.similarity]
default_metric = "cosine"
top_k_default = 5

# ============================================================================
# VECTOR DATABASE CONFIGURATION
# ============================================================================
[storage]
# Multi-tenant ChromaDB storage settings
db_path = "./data/chromadb"                    # Legacy single-tenant path (deprecated)
db_path_template = "{data_base_dir}/{tenant_slug}/vectordb"  # Multi-tenant template

# Collection naming templates
collection_name = "multilingual_documents"    # Legacy single-tenant (deprecated)
collection_name_template = "{tenant_slug}_{scope}_{language}"  # Multi-tenant template
# Examples: "development_user_hr", "enterprise_tenant_en", "acme_user_multilingual"

distance_metric = "cosine"  # "cosine", "l2", "ip" (inner product)
persist = true
allow_reset = false

# Document metadata defaults
[storage.metadata]
content_types = ["pdf", "docx", "txt"]

[search]
# Search configuration (uses shared.default_top_k and shared.similarity_threshold)
default_method = "semantic"  # "semantic", "keyword", "hybrid"
max_context_length = 2000  # Specific to search display
rerank = true
include_metadata = true
include_distances = true

# Hybrid search weights
[search.weights]
semantic_weight = 0.7
keyword_weight = 0.3

[vectordb.factory]
# Factory settings for vectordb components
auto_create_collection = true
default_embedding_function = "sentence_transformers"
chunk_size = 1000
chunk_overlap = 100

# ============================================================================
# DOCUMENT PROCESSING CONFIGURATION
# ============================================================================
[processing]
# Document processing settings (uses shared chunk size standards)
sentence_chunk_overlap = 2
preserve_paragraphs = true
enable_smart_chunking = true
respect_document_structure = true

[extraction]
# Document extraction settings
supported_formats = [".pdf", ".docx", ".txt", ".html", ".md"]
preserve_formatting = true
extract_metadata = true
handle_images = false
ocr_enabled = false
max_file_size_mb = 50  # Maximum file size for processing
enable_logging = true  # Enable extraction logging
encoding_detection = true
text_encodings = ["utf-8", "cp1252", "iso-8859-1", "iso-8859-2"]

[chunking]
# Text chunking configuration (uses shared chunk size standards)
strategy = "sliding_window"  # "sliding_window", "sentence", "paragraph"
max_chunk_size = 1024  # Specific override for chunking (larger than default)
preserve_sentence_boundaries = true
respect_paragraph_breaks = true
enable_smart_splitting = true
sentence_search_range = 100

# Common paragraph and sentence settings (language-specific settings in language files)
paragraph_separators = ["\n\n", "\r\n\r\n"]  # Universal paragraph separators
min_sentence_length = 10  # Minimum sentence length for all languages

[cleaning]
# Text cleaning settings
remove_extra_whitespace = true
normalize_unicode = true
preserve_formatting = false
remove_headers_footers = true
handle_tables = true
extract_links = false
preserve_line_breaks = false
fix_encoding_issues = true
remove_page_numbers = true
clean_ocr_artifacts = true
normalize_punctuation = true

# Regex patterns for text cleaning
multiple_whitespace = "\\s+"
multiple_linebreaks = "\\n{3,}"
min_meaningful_words = 3
min_word_char_ratio = 0.7

# Text quality settings
min_character_ratio = 0.7

[formatting_patterns]
# Croatian-specific formatting patterns (references croatian.toml)
date_formats = ["dd.mm.yyyy", "d.m.yyyy", "dd/mm/yyyy"]
number_formats = ["1.234,56", "1 234,56"]
currency_symbols = ["kn", "HRK", "€", "EUR"]
address_patterns = ["\\d{5}\\s+[A-ZČĆŽŠĐ][a-zčćžšđ]+"]
phone_patterns = ["\\+385\\s*\\d{1,2}\\s*\\d{3}\\s*\\d{3,4}"]
email_patterns = ["[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"]

# ============================================================================
# RETRIEVAL CONFIGURATION
# ============================================================================
[query_processing]
# Query processing settings
language = "hr"  # Croatian language code
expand_synonyms = true
normalize_case = true
remove_stopwords = true
min_query_length = 3
max_query_length = 500
max_expanded_terms = 10
enable_morphological_analysis = true
use_query_classification = true
enable_spell_check = false

[retrieval]
# Retrieval configuration - OPTIMIZED FOR SPEED (uses shared.default_top_k)
default_k = 3                 # Reduced from 5 - fewer chunks = faster generation
max_k = 8                     # Reduced from 10
adaptive_retrieval = true
enable_reranking = true
diversity_lambda = 0.3
use_hybrid_search = true
enable_query_expansion = true

[ranking]
# Document ranking and scoring
method = "language_enhanced"
enable_diversity = true
diversity_threshold = 0.8
boost_recent = true
boost_authoritative = true
content_length_factor = true
keyword_density_factor = true
language_specific_boost = true  # Enable language-specific ranking features
boost_exact_match = 1.5
boost_title_match = 1.3
boost_metadata_match = 1.2
decay_factor = 0.95

[ranking.weights]
# Ranking component weights
content_weight = 0.6
title_weight = 0.2
metadata_weight = 0.1
freshness_weight = 0.1

[reranking]
# Cross-encoder reranking settings (uses shared.default_device)
enabled = true
model_name = "BAAI/bge-reranker-v2-m3"  # BGE-reranker-v2-m3: Best multilingual reranker for Croatian
max_length = 512
batch_size = 4  # Specific to reranking (smaller than default)
top_k = 20  # Specific to reranking (larger than default)
use_fp16 = true  # Speed up computation with slight performance degradation
normalize = true  # Map scores to 0-1 range using sigmoid

[hybrid_retrieval]
# Hybrid retrieval combining dense and sparse
dense_weight = 0.7
sparse_weight = 0.3
fusion_method = "rrf"  # "linear", "rrf" (Reciprocal Rank Fusion)
bm25_k1 = 1.2
bm25_b = 0.75

# ============================================================================
# GENERATION CONFIGURATION
# ============================================================================
[ollama]
# Ollama LLM configuration - OPTIMIZED FOR PERFORMANCE (uses shared.generation_timeout)
base_url = "http://localhost:11434"
model = "qwen2.5:7b-instruct"  # Fast multilingual model with good quality
temperature = 0.7
max_tokens = 800               # Reduced from 2000 for faster generation
top_p = 0.9
top_k = 40                     # Specific to generation (different from search top_k)
stream = true
keep_alive = "5m"
num_predict = 800              # Cap token generation
repeat_penalty = 1.1
seed = -1

[prompts]
# Prompt configuration
system_prompt_template = "rag_system"
user_prompt_template = "rag_user"
context_template = "rag_context"
use_few_shot_examples = true
max_context_length = 4000
include_source_references = true

[response_parsing]
# Response parsing and validation
validate_responses = true
extract_confidence_scores = true
parse_citations = true
handle_incomplete_responses = true
max_response_length = 3000
min_response_length = 50
filter_hallucinations = true
require_source_grounding = true
confidence_threshold = 0.7
response_format = "markdown"
include_metadata = true

# ============================================================================
# SYSTEM CONFIGURATION
# ============================================================================
[system]
# System-wide settings (uses shared directories and timeouts)
log_level = "INFO"
enable_caching = true
max_concurrent_requests = 5
enable_metrics = true

[performance]
# Performance optimization settings
use_async_processing = true
parallel_document_processing = true
max_workers = 4
batch_processing_size = 10
memory_limit_mb = 2048
enable_gpu_acceleration = false

# ============================================================================
# PIPELINE ORCHESTRATION
# ============================================================================
[pipeline]
# Main pipeline settings
enable_preprocessing = true
enable_embeddings = true
enable_storage = true
enable_retrieval = true
enable_generation = true
enable_monitoring = true

# Note: Timeouts are now in [shared] section - no need for separate pipeline.timeouts

[pipeline.retries]
# Retry configuration
max_retries = 3
retry_delay = 1.0
exponential_backoff = true
retry_on_timeout = true
retry_on_connection_error = true

# ============================================================================
# MULTI-TENANT CONFIGURATION
# ============================================================================
[multi_tenant]
# Multi-tenancy settings
enable_multi_tenancy = true
default_tenant_slug = "development"
auto_create_tenant_folders = true
tenant_isolation_mode = "strict"  # "strict" or "shared"

# Tenant limits and quotas
max_tenants = 100
max_users_per_tenant = 1000
max_documents_per_tenant = 10000
max_documents_per_user = 1000

# Folder management
create_missing_folders = true
validate_tenant_paths = true
cleanup_empty_folders = false

# Collection management
auto_create_collections = true
collection_per_language = true
collection_per_scope = true  # Separate user/tenant collections
